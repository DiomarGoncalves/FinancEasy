<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #fff;
        }
        .form-control,
        .form-select {
            background-color: #444;
            color: #fff;
            border-color: #333;
        }
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            border-color: #555;
        }
        .hidden {
            display: none;
        }
        .menu {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .menu button {
            margin: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="menu">
            <button class="btn btn-primary" onclick="showForm('despesasForm')">Filtrar Despesas</button>
            <button class="btn btn-primary" onclick="showForm('receitasForm')">Filtrar Receitas</button>
            <button class="btn btn-primary" onclick="calcularSaldo()">Calcular Saldo</button>
        </div>

        <div id="despesasForm" class="hidden">
            <h2>Filtrar Despesas</h2>
            <form id="formDespesas">
                <div class="mb-3">
                    <label for="dataInicioDespesas" class="form-label">Data Início</label>
                    <input type="date" class="form-control" id="dataInicioDespesas" name="dataInicioDespesas">
                </div>
                <div class="mb-3">
                    <label for="dataFimDespesas" class="form-label">Data Fim</label>
                    <input type="date" class="form-control" id="dataFimDespesas" name="dataFimDespesas">
                </div>
                <button type="button" class="btn btn-light" onclick="filtrarDespesas()">Filtrar</button>
                <button type="button" class="btn btn-secondary" onclick="hideForm('despesasForm')">Cancelar</button>
            </form>
            <h3>Pré-visualização</h3>
            <table class="table table-dark table-striped" id="previewDespesasTable">
                <thead>
                    <tr>
                        <th>Estabelecimento</th>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Forma de Pagamento</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Linhas serão adicionadas dinamicamente -->
                </tbody>
            </table>
            <button class="btn btn-success" onclick="gerarRelatorioDespesas()">Gerar Relatório</button>
        </div>

        <div id="receitasForm" class="hidden">
            <h2>Filtrar Receitas</h2>
            <form id="formReceitas">
                <div class="mb-3">
                    <label for="dataInicioReceitas" class="form-label">Data Início</label>
                    <input type="date" class="form-control" id="dataInicioReceitas" name="dataInicioReceitas">
                </div>
                <div class="mb-3">
                    <label for="dataFimReceitas" class="form-label">Data Fim</label>
                    <input type="date" class="form-control" id="dataFimReceitas" name="dataFimReceitas">
                </div>
                <button type="button" class="btn btn-light" onclick="filtrarReceitas()">Filtrar</button>
                <button type="button" class="btn btn-secondary" onclick="hideForm('receitasForm')">Cancelar</button>
            </form>
            <h3>Pré-visualização</h3>
            <table class="table table-dark table-striped" id="previewReceitasTable">
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Forma de Recebimento</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Linhas serão adicionadas dinamicamente -->
                </tbody>
            </table>
            <button class="btn btn-success" onclick="gerarRelatorioReceitas()">Gerar Relatório</button>
        </div>
    </div>

    <script>
        function showForm(formId) {
            document.getElementById(formId).classList.remove('hidden');
        }

        function hideForm(formId) {
            document.getElementById(formId).classList.add('hidden');
        }

        async function filtrarDespesas() {
            const dataInicio = document.getElementById('dataInicioDespesas').value;
            const dataFim = document.getElementById('dataFimDespesas').value;
            const filtros = { dataInicio, dataFim };
            console.log('Filtros:', filtros); // Log para depuração
            const despesas = await window.controle.getDespesasFiltradas(filtros);
            console.log('Despesas filtradas:', despesas); // Log para depuração
            const tableBody = document.querySelector("#previewDespesasTable tbody");
            tableBody.innerHTML = ""; // Limpar tabela

            despesas.forEach((despesa) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${despesa.estabelecimento}</td>
                    <td>${despesa.data}</td>
                    <td>R$ ${despesa.valor.toFixed(2)}</td>
                    <td>${despesa.forma_pagamento}</td>
                `;
                tableBody.appendChild(row); // Adicionar linha à tabela
            });
        }

        async function filtrarReceitas() {
            const dataInicio = document.getElementById('dataInicioReceitas').value;
            const dataFim = document.getElementById('dataFimReceitas').value;
            const filtros = { dataInicio, dataFim };
            console.log('Filtros:', filtros); // Log para depuração
            const receitas = await window.controle.getReceitasFiltradas(filtros);
            console.log('Receitas filtradas:', receitas); // Log para depuração
            const tableBody = document.querySelector("#previewReceitasTable tbody");
            tableBody.innerHTML = ""; // Limpar tabela

            receitas.forEach((receita) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${receita.descricao}</td>
                    <td>${receita.data}</td>
                    <td>R$ ${receita.valor.toFixed(2)}</td>
                    <td>${receita.forma_recebimento}</td>
                `;
                tableBody.appendChild(row); // Adicionar linha à tabela
            });
        }

        async function calcularSaldo() {
            const { saldo } = await window.controle.calcularSaldo();
            alert(`Saldo atual: R$ ${saldo.toFixed(2)}`);
        }

        function gerarRelatorioDespesas() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Relatório de Despesas", 10, 10);
            doc.autoTable({
                html: '#previewDespesasTable',
                didDrawPage: (data) => {
                    // Adicionar o total gasto no final da página
                    const pageHeight = doc.internal.pageSize.height;
                    const totalGasto = Array.from(data.table.body).reduce((acc, row) => {
                        const valor = parseFloat(row.cells[2].textContent.replace('R$ ', ''));
                        return acc + (isNaN(valor) ? 0 : valor);
                    }, 0);
                    doc.text(`Total Gasto: R$ ${totalGasto.toFixed(2)}`, 10, pageHeight - 10);
                }
            });
            doc.save('relatorio_despesas.pdf');
        }

        function gerarRelatorioReceitas() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Relatório de Receitas", 10, 10);
            doc.autoTable({
                html: '#previewReceitasTable',
                didDrawPage: (data) => {
                    // Adicionar o total recebido no final da página
                    const pageHeight = doc.internal.pageSize.height;
                    const totalRecebido = Array.from(data.table.body).reduce((acc, row) => {
                        const valor = parseFloat(row.cells[2].textContent.replace('R$ ', ''));
                        return acc + (isNaN(valor) ? 0 : valor);
                    }, 0);
                    doc.text(`Total Recebido: R$ ${totalRecebido.toFixed(2)}`, 10, pageHeight - 10);
                }
            });
            doc.save('relatorio_receitas.pdf');
        }
    </script>
</body>
</html>